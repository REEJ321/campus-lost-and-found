<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Lost & Found</title>
    <style>
      body {
        font-family: Poppins, sans-serif;
        background: url("https://i0.wp.com/metrocdodev.com/wp-content/uploads/2024/08/image-510.png?resize=1024%2C768&ssl=1")
          no-repeat center center fixed;
        background-size: cover;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: -1;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        width: 350px;
      }
      input,
      button {
        width: 100%;
        box-sizing: border-box;
      }
      input {
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px;
        margin-top: 15px;
        border: none;
        background: #3498db;
        color: #fff;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #2980b9;
      }
      h2 {
        text-align: center;
        margin: 0;
      }
      p {
        text-align: center;
        margin-top: 10px;
        font-size: 0.9rem;
      }
      a {
        color: #3498db;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .password-container {
        position: relative;
      }
      .password-container span {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" required />

      <div class="password-container">
        <input type="password" id="password" placeholder="Password" required />
        <span id="togglePassword">ðŸ™ˆ</span>
      </div>

      <button id="loginBtn">Login</button>
      <button onclick="location.href='student.html'">View Lost Items</button>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      class EventEmitter {
        constructor() {
          this.events = {};
        }

        on(event, listener) {
          if (!this.events[event]) {
            this.events[event] = [];
          }
          this.events[event].push(listener);
        }

        emit(event, data) {
          if (this.events[event]) {
            this.events[event].forEach((listener) => listener(data));
          }
        }

        off(event, listenerToRemove) {
          if (!this.events[event]) return;
          this.events[event] = this.events[event].filter(
            (listener) => listener !== listenerToRemove
          );
        }
      }

      const events = new EventEmitter();

      const supabase = createClient(
        "https://qypvwkxmtrfgnfhhcxia.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5cHZ3a3htdHJmZ25maGhjeGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3ODcxNjAsImV4cCI6MjA3NjM2MzE2MH0.Mdam3ABGs8eF0682iSuv6UAOAF7BOIWTzhTaz-w5m2s"
      );

      events.on("app:init", async () => {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (session) {
          events.emit("session:found", { userId: session.user.id });
        }
      });

      events.on("session:found", async ({ userId }) => {
        const { data: profile } = await supabase
          .from("user_profiles")
          .select("role")
          .eq("id", userId)
          .single();

        if (profile?.role === "admin") {
          events.emit("redirect:admin");
        } else {
          events.emit("redirect:student");
        }
      });

      events.on("redirect:admin", () => {
        location.href = "admin.html";
      });

      events.on("redirect:student", () => {
        location.href = "student.html";
      });

      events.on("login:attempt", async ({ email, password }) => {
        if (!email || !password) {
          events.emit(
            "login:validationFailed",
            "Please enter email and password."
          );
          return;
        }

        const { data: loginData, error: loginError } =
          await supabase.auth.signInWithPassword({
            email,
            password,
          });

        if (loginError) {
          events.emit("login:failed", loginError);
          return;
        }

        events.emit("login:success", { userId: loginData.user.id });
      });

      events.on("login:validationFailed", (message) => {
        alert(message);
      });

      events.on("login:failed", (error) => {
        if (error.message.includes("not confirmed")) {
          alert("Your email is not confirmed.");
        } else {
          alert("Login failed: " + error.message);
        }
      });

      events.on("login:success", async ({ userId }) => {
        const { data: profile, error: profileError } = await supabase
          .from("user_profiles")
          .select("role")
          .eq("id", userId)
          .single();

        if (profileError) {
          alert("Failed to fetch role: " + profileError.message);
          return;
        }

        if (profile.role === "admin") {
          events.emit("redirect:admin");
        } else {
          events.emit("redirect:student");
        }
      });

      events.on("password:toggle", () => {
        const passwordInput = document.getElementById("password");
        const toggle = document.getElementById("togglePassword");

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          toggle.textContent = "ðŸ™‰";
        } else {
          passwordInput.type = "password";
          toggle.textContent = "ðŸ™ˆ";
        }
      });

      window.addEventListener("load", () => {
        events.emit("app:init");
      });

      document.getElementById("loginBtn").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        events.emit("login:attempt", { email, password });
      });

      document
        .getElementById("togglePassword")
        .addEventListener("click", () => {
          events.emit("password:toggle");
        });

      supabase.auth.onAuthStateChange((authEvent, session) => {
        events.emit("auth:stateChange", { event: authEvent, session });
      });
    </script>
  </body>
</html>
